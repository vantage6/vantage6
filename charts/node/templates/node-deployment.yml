apiVersion: apps/v1
kind: Deployment
metadata:
  name: {{ .Release.Name }}-node-deployment
  namespace: {{ .Release.Namespace | quote }}
  labels:
{{ include "node.labels" . | indent 4 }}
    component: node
spec:
  selector:
    matchLabels:
{{ include "node.matchLabels" . | indent 6 }}
      component: node
  template:
    metadata:
      labels:
{{ include "node.labels" . | indent 8 }}
        component: node
    spec:
    #   hostAliases:
    #   - ip: "172.17.0.1" # Default bridge network gateway for docker/k8s
    #     hostnames:
    #     - "host.docker.internal" # Defining it explicitly for environments where Docker is not installed
      containers:
      - name: vantage6-node
        image: {{ .Values.node.image }}
        env:
        - name: PROXY_SERVER_PORT
          value: "{{ .Values.node.proxyPort }}"
        command: ["vnode-local", "start", "-c", "/app/config/config.yml", "--dockerized"]
        volumeMounts:
        - name: task-files-root
          mountPath: {{ .Values.node.taskDir }}
        - name: kube-config-file
          mountPath: /app/.kube/config
        - name: config-volume
          mountPath: /app/config
        # TODO do we need to mount databases in the node container? They are mounting
        # the host path to the algorithm containers right?
        {{- range .Values.node.databases.fileBased }}
        - name: database-volume-{{ .name }}
          mountPath: /app/databases/{{ .name }}.{{ .type }}
        {{- end }}
      volumes:
      {{- range .Values.node.databases.fileBased }}
      - name: database-volume-{{ .name }}
        hostPath:
          path: {{ .uri }}
          type: File
      {{- end }}
      - name: task-files-root
        hostPath:
          path: {{ .Values.node.taskDirHost }}
          type: DirectoryOrCreate
      - name: kube-config-file
        hostPath:
          path: {{ .Values.node.kubeConfig }}
          type: File
      - name: config-volume
        configMap:
          name: {{ .Release.Name }}-node-configmap
