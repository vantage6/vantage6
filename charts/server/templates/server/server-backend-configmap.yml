apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ .Release.Name }}-vantage6-server-config
  namespace: {{ .Values.namespace | default .Release.Namespace }}
data:
  config.yaml: |
    algorithm_stores: []
    {{- if .Values.server.allow_drop_all }}
    allow_drop_all: {{ .Values.server.allow_drop_all }}
    {{- else }}
    allow_drop_all: False
    {{- end }}
    api_path: {{ .Values.server.apiPath }}
    description: {{ .Values.server.description }}
    ip: 0.0.0.0
    {{- if .Values.server.jwt }}
    {{- if .Values.server.jwt.secret }}
    jwt_secret_key: {{ .Values.server.jwt.secret }}
    {{- end }}
    {{- end }}
    logging:
      backup_count: {{ .Values.server.logging.backup_count }}
      datefmt: {{ .Values.server.logging.datefmt | quote }}
      file: {{ .Values.server.logging.file }}
      format: {{ .Values.server.logging.format | quote }}
      level: {{ .Values.server.logging.level }}
      loggers:
      {{- range .Values.server.logging.loggers }}
      - level: {{ .level }}
        name: {{ .name }}
      {{- end }}
      max_size: {{ .Values.server.logging.max_size }}
      use_console: {{ .Values.server.logging.use_console }}
    port: {{ .Values.server.internal.port }}
    server_url: {{ .Values.server.baseUrl }}{{ .Values.server.apiPath }}
    {{- if .Values.server.database_uri }}
    uri: {{ .Values.server.database_uri }}
    {{- else if .Values.database.username }}
    uri: postgresql://{{ .Values.database.username }}:{{ .Values.database.password }}@{{ .Release.Name }}-postgres-service:5432/{{ .Values.database.name }}
    {{- else }}
    uri: ""
    {{- end }}
    rabbitmq:
    {{- if .Values.server.rabbitmq_uri }}
      uri: {{ .Values.server.rabbitmq_uri }}
    {{- else if .Values.rabbitmq.username }}
      uri: amqp://{{ .Values.rabbitmq.username }}:{{ .Values.rabbitmq.password }}@{{ .Release.Name }}-rabbitmq-service:5672/{{ .Values.rabbitmq.vhost }}
    {{- else }}
      uri: ""
    {{- end }}
      start_with_server: false
    {{- if .Values.server.dev.host_uri }}
    dev:
      host_uri: {{ .Values.server.dev.host_uri }}
    {{- end }}
    keycloak:
      {{- if hasKey .Values.server.keycloak "manage_users_and_nodes" }}
      manage_users_and_nodes: {{ .Values.server.keycloak.manage_users_and_nodes }}
      {{- else }}
      manage_users_and_nodes: true
      {{- end }}